@page "/appointment"
@using System.ComponentModel.DataAnnotations
@inject IServiceService ServiceService
@inject ILogger<Appointment> logger

<div class="appointment-container">
    <h1>Appointment</h1>
    <EditForm Model="@formData" OnInvalidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="name">Name:</label>
                <InputText id="name" class="form-control" @bind-Value="formData.Name" />
                <ValidationMessage For="@(() => formData.Name)" />
            </div>
            <div class="col-md-6">
                <label for="phone">Phone:</label>
                <InputText id="phone" class="form-control" @bind-Value="formData.Phone" />
                <ValidationMessage For="@(() => formData.Phone)" />
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="date">Date:</label>
                <InputDate id="date" class="form-control" @bind-Value:after="AfterDateChanged" @bind-Value="formData.Date" />
                <ValidationMessage For="@(() => formData.Date)" />
            </div>
            <div class="col-md-6">
                <label for="time">Time:</label>
                <select id="time" class="form-select" @bind="formData.Time">
                    <option value=""></option>
                    @foreach (var time in times)
                    {
                        <option value="@time.value">@time.display</option>
                    }
                </select>
                <ValidationMessage For="@(() => formData.Time)" />
            </div>
        </div>
        <div class="row mb-3">
            <label for="services-multiselect">Select Service(s):</label>
            <div class="services-list" id="services-multiselect">
                @foreach (var service in allServices)
                {
                    <div class="service-item @(formData.SelectedServices.Contains(service) ? "selected-service" : null)"
                         @onclick="() => ToggleServiceSelection(service)">
                        @($"{service.Name}   {service.Price:C2}")
                    </div>
                }
            </div>
            <ValidationMessage For="@(() => formData.SelectedServices)" />
        </div>
        <button type="submit" class="btn-appointment">Submit</button>
    </EditForm>
</div>


@code {
    private FormData formData = new FormData();
    private List<Service> allServices = new();
    private List<(DateTime value, string display)> times = new();

    protected override async Task OnInitializedAsync()
    {
        times.AddRange(
        [
            (DateTime.Now, "4 pm"),
            (DateTime.Now.AddMinutes(3), "5 pm"),
    ]);
        await LoadServicesAsync();
        await base.OnInitializedAsync();
    }

    private async Task LoadServicesAsync()
    {
        try
        {
            allServices = await ServiceService.GetAllServicesAsync();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, $"failed to load {nameof(Service)} from api");
        }
    }

    private async Task AfterDateChanged()
    {
        formData.Time = null;
        times.Clear();
        times.AddRange(
        [
            (DateTime.Now, "6 pm"),
    ]);
    }

    private void ToggleServiceSelection(Service service)
    {
        if (formData.SelectedServices.Contains(service))
        {
            formData.SelectedServices.Remove(service);
        }
        else
        {
            formData.SelectedServices.Add(service);
        }
    }

    private void HandleValidSubmit()
    {
        var s = formData.SelectedServices;
    }

    public class FormData
    {
        [Required]
        public string Name { get; set; }

        [Required]
        [Phone]
        public string Phone { get; set; }

        [Required]
        public DateTime Date { get; set; } = DateTime.Now;

        [Required]
        public DateTime? Time { get; set; } = null;

        public List<Service> SelectedServices { get; set; } = new();
    }
}
