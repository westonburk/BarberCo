@page "/services"
@using BarberCo.SharedLibrary.Dtos
@using BarberCo.SharedLibrary.Services
@using BarberCo.SharedLibrary.Models
@using Microsoft.AspNetCore.Components.Authorization
@using System.ComponentModel.DataAnnotations
@inject IServiceService ServiceService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IAuthService AuthService

<PageTitle>Services</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Services</MudText>

    <MudPaper Elevation="0" Class="d-flex justify-end mb-4">
        <AuthorizeView Roles="admin">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.AddCircle"
                       OnClick="OpenAddServiceDialog">
                Add Service
            </MudButton>
        </AuthorizeView>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="my-8" />
    }
    else
    {
        <MudDataGrid Items="_services" Filterable="false" SortMode="@SortMode.None" Groupable="false">
            <Columns>
                <PropertyColumn Property="x => x.Name" />
                <PropertyColumn Property="x => x.Price" Format="C2" />
                <TemplateColumn Hidden="@(_isAdmin == false)" CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                            <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                         OnClick="@(() => OpenEditServiceDialog(context.Item))">
                                Edit
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Delete"
                                         OnClick="@(() => DeleteService(context.Item))">
                                Delete
                            </MudMenuItem>
                        </MudMenu>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudContainer>

@* Add/Edit Service Dialog *@
<MudDialog @bind-Visible="_dialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(_isEditMode ? $"Edit Service - {_editingService?.Name}" : "Add New Service")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField T="string"
                                  Label="Service Name"
                                  @bind-Value="_formModel.Name"
                                  Required="true"
                                  RequiredError="Service name is required"
                                  Variant="Variant.Outlined"
                                  Immediate="true"
                                  HelperText="e.g., Haircut, Beard Trim, etc." />
                </MudItem>

                <MudItem xs="12">
                    <MudNumericField T="decimal"
                                     Label="Price"
                                     @bind-Value="_formModel.Price"
                                     Required="true"
                                     RequiredError="Price is required"
                                     Variant="Variant.Outlined"
                                     Immediate="true"
                                     Format="C2"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                     HelperText="Enter the service price" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _dialogVisible = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="SaveService"
                   Disabled="@(!_formIsValid || _savingService)">
            @if (_savingService)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @(_isEditMode ? "Update" : "Add") Service
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private MudForm _form;
    private bool _formIsValid;
    private bool _loading = true;
    private bool _savingService = false;
    private List<Service> _services = new();
    private bool _isAdmin = false;
    private TokenDto _currentUser;

    // Dialog state
    private bool _dialogVisible = false;
    private bool _isEditMode = false;
    private Service? _editingService;
    private ServiceUpdateDto _formModel = new();

    protected override async Task OnInitializedAsync()
    {
        // Check if user is admin
        _currentUser = await AuthService.GetCurrentTokenAsync();
        _isAdmin = _currentUser.Roles.Contains("admin");

        await LoadServicesAsync();
    }

    private async Task LoadServicesAsync()
    {
        try
        {
            _loading = true;
            _services = await ServiceService.GetAllServicesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading services: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OpenAddServiceDialog(MouseEventArgs args)
    {
        _isEditMode = false;
        _editingService = null;
        _formModel = new ServiceUpdateDto();
        _dialogVisible = true;
    }

    private void OpenEditServiceDialog(Service service)
    {
        _isEditMode = true;
        _editingService = service;
        _formModel = new ServiceUpdateDto
        {
            Name = service.Name,
            Price = service.Price
        };
        _dialogVisible = true;
    }

    private async Task SaveService()
    {
        if (!_formIsValid || _savingService) return;

        try
        {
            _savingService = true;

            if (_isEditMode && _editingService != null)
            {
                // Update existing service
                var result = await ServiceService.UpdateServiceAsync(_formModel, _editingService);

                // Update the service in the list
                var index = _services!.FindIndex(s => s.Id == result.Id);
                if (index >= 0)
                {
                    _services[index] = result;
                }

                Snackbar.Add("Service updated successfully", Severity.Success);
            }
            else
            {
                // Create new service
                var result = await ServiceService.CreateServiceAsync(_formModel);

                _services!.Add(result);
                _services = _services.OrderBy(s => s.Name).ToList(); // Keep list sorted

                Snackbar.Add("Service created successfully", Severity.Success);
            }

            _dialogVisible = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving service: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingService = false;
        }
    }

    private async Task DeleteService(Service service)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Service",
            $"Are you sure you want to delete \"{service.Name}\"? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await ServiceService.DeleteServiceAsync(service);

                // Remove the service from the list
                _services!.Remove(service);

                Snackbar.Add("Service deleted successfully", Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting service: {ex.Message}", Severity.Error);
            }
        }
    }
}