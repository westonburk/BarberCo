@page "/hours"
@using BarberCo.SharedLibrary.Models
@using BarberCo.SharedLibrary.Services
@using BarberCo.SharedLibrary.Dtos
@inject IHourService HourService
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<PageTitle>Business Hours</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Business Hours</MudText>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="my-8" />
    }
    else
    {
        <MudDataGrid Items="_hours" Filterable="false" SortMode="@SortMode.None" Groupable="false">
            <Columns>
                <PropertyColumn Property="x => x.hour.DayOfWeek" Title="Day" />
                <TemplateColumn Title="Open">
                    <CellTemplate>@(context.Item.hour.IsClosed ? "" : context.Item.hour.StartTime.ToString("h:mm tt"))</CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Close">
                    <CellTemplate>@(context.Item.hour.IsClosed ? "" : context.Item.hour.EndTime.ToString("h:mm tt"))</CellTemplate>
                </TemplateColumn>
                <TemplateColumn>
                    <CellTemplate>
                        <MudChip Color="@(context.Item.hour.IsClosed? Color.Default: Color.Success)"
                                 Size="Size.Small"
                                 T="string">
                            @(context.Item.hour.IsClosed ? "Closed" : "Open")
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Hidden="@(_isAdmin == false)" CellClass="edit-grid-cell">
                    <CellTemplate>
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@(() => OpenEditHourDialog(context.Item.hour))" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudContainer>

@* Edit Hour Dialog *@
<MudDialog @bind-Visible="_dialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            Edit Hours - @_editingHour?.DayOfWeek
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
            <MudGrid>
                <MudItem xs="12">
                    <MudSwitch @bind-Value="_formModel.IsClosed"
                               Label="Closed for business"
                               Color="Color.Primary"
                               Class="mb-4" />
                </MudItem>

                @if (!_formModel.IsClosed)
                {
                    <MudItem xs="12" sm="6">
                        <MudSelect T="TimeOnly"
                                   Label="Opening Time"
                                   @bind-Value="_formModel.StartTime"
                                   Required="true"
                                   RequiredError="Opening time is required"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var time in _timeOptions)
                            {
                                <MudSelectItem Value="@time">@time.ToString("h:mm tt")</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="TimeOnly"
                                   Label="Closing Time"
                                   @bind-Value="_formModel.EndTime"
                                   Required="true"
                                   RequiredError="Closing time is required"
                                   Validation="@(new Func<TimeOnly, string>(ValidateEndTime))"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var time in _timeOptions.Where(t => t > _formModel.StartTime))
                            {
                                <MudSelectItem Value="@time">@time.ToString("h:mm tt")</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Dense="true">
                            Business hours: @_formModel.StartTime.ToString("h:mm tt") to @_formModel.EndTime.ToString("h:mm tt")
                            @{
                                var duration = _formModel.EndTime - _formModel.StartTime;
                                var hours = (int)duration.TotalHours;
                            }
                            (@hours hours)
                        </MudAlert>
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Warning" Dense="true">
                            This day will be marked as closed. Customers won't be able to book appointments.
                        </MudAlert>
                    </MudItem>
                }
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _dialogVisible = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="SaveHour"
                   Disabled="@(!_formIsValid || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Update Hours
        </MudButton>
    </DialogActions>
</MudDialog>

<style>
    .edit-grid-cell {
       text-align: right;
    }
</style>

@code {
    private MudForm _form;
    private bool _formIsValid;
    private bool _loading = true;
    private bool _saving = false;
    private List<(int sort, Hour hour)> _hours = new();
    private List<TimeOnly> _timeOptions = new();
    private bool _isAdmin = false;
    private TokenDto _currentUser;

    // Dialog state
    private bool _dialogVisible = false;
    private Hour? _editingHour;
    private HourFormModel _formModel = new();

    public class HourFormModel
    {
        public TimeOnly StartTime { get; set; }
        public TimeOnly EndTime { get; set; }
        public bool IsClosed { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Check if user is admin
        _currentUser = await AuthService.GetCurrentTokenAsync();
        _isAdmin = _currentUser.Roles.Contains("admin");

        // Generate time options (every hour from 12:00 AM to 11:00 PM)
        for (int hour = 0; hour < 24; hour++)
        {
            _timeOptions.Add(new TimeOnly(hour, 0));
        }

        await LoadHours();
    }

    private async Task LoadHours()
    {
        try
        {
            _loading = true;
            _hours = await HourService.GetAllHoursAsync();
            _hours = _hours.OrderBy(h => h.sort).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading hours: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OpenEditHourDialog(Hour hour)
    {
        _editingHour = hour;
        _formModel = new HourFormModel
        {
            StartTime = TimeOnly.FromDateTime(hour.StartTime),
            EndTime = TimeOnly.FromDateTime(hour.EndTime),
            IsClosed = hour.IsClosed
        };
        _dialogVisible = true;
    }

    private async Task SaveHour()
    {
        if (!_formIsValid || _saving || _editingHour == null) return;

        try
        {
            _saving = true;

            // date portion doesn't matter. it is taken out by the api
            var seedDate = new DateOnly(2020, 12, 1);
            var dto = new HourUpdateDto
            {
                StartTime = seedDate.ToDateTime(_formModel.StartTime),
                EndTime = seedDate.ToDateTime(_formModel.EndTime),
                IsClosed = _formModel.IsClosed
            };

            var result = await HourService.UpdateHourAsync(_editingHour, dto);

            // Update the hour in the list
            var index = _hours.FindIndex(h => h.hour.Id == result.Id);
            if (index >= 0)
            {
                _hours[index] = (_hours[index].sort, result);
            }

            _dialogVisible = false;
            Snackbar.Add("Hours updated successfully", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving hours: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private string ValidateEndTime(TimeOnly endTime)
    {
        if (endTime <= _formModel.StartTime)
            return "Closing time must be after opening time";
        return null;
    }
}